import subprocess
from pathlib import Path

from .utils import package_dir as this_package_dir


def package_data():
    """Prep python package data."""

    from genai_prices.types import __file__ as genai_prices_file, providers_schema

    data_path = this_package_dir / 'data.json'

    providers_schema.rebuild()
    providers = providers_schema.validate_json(data_path.read_bytes())

    data_content = f'''\
"""DO NOT EDIT THIS FILE DIRECTLY, INSTEAD RUN `make package-data`"""
from decimal import Decimal

from .types import *

__all__ = ('providers',)

providers: list[Provider] = {providers}
'''

    py_package_dir = Path(genai_prices_file).parent
    data_py = py_package_dir / 'data.py'
    data_py.write_text(data_content)
    root_dir = this_package_dir.parent
    subprocess.run(['uv', 'run', 'ruff', 'format', str(data_py)], cwd=str(root_dir), check=True)

    print(f'Data successfully written to {data_py.relative_to(root_dir)}')
